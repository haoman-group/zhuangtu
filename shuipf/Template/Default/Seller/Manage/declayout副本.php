<!doctype html>
<html>
<head>
<meta charset="UTF-8">
<title>布局装修</title>
<link rel="stylesheet" type="text/css" href="{$config_siteurl}statics/zt/css/decorate.css" >
<script src="{$config_siteurl}statics/zt/js/jquery.js"></script>
<script src="{$config_siteurl}statics/zt/js/decorate.js"></script>
</head>

<body class="decbody">


<div class="wrap">

	<template file="Seller/common/_dectop.php"/>
    
    
    <div class="mainwrap">

		<template file="Seller/common/_decleft.php"/>

        <div class="mkmain">
        	<div class="mhead">
            	<div class="selebox">
                	
                </div>
                <div class="pagemod">
                	<a href="decorate" >页面编辑</a>
                    <a href="declayout" class="on">布局编辑</a>
                </div>
                <div class="ops">
                	<a href="">备份</a>
                    <a href="">预览</a>
                    <a href="">发布</a>
                </div>
            </div>

            <div class="workpage">
            	<div class="pagein">
                	<div class="layout-con">
                    	<div class="layoutmain layouteditmain" data-maxlayout="5" data-maxmods="40">
                        	<div class="layout-hd">
                            	<div class="layout layout-block" data-ltype="ltop" data-widgetid="12346745822" data-componentid="23" data-prototypeid="23" data-id="12346745822" data-max="2">
                                	<p class="title">店铺页头</p>
                                    <div class="col-main">
                                        <div class="main-wrap J_TRegion" data-modules="main" data-width="h950" data-max="2">
                                    		<div class="J_TModule tb-module shop12346745824" data-widgetid="12346745824" data-componentid="5002" data-spm="'110.0.5002-12346745824'" microscope-data="'5002-12346745824'" data-title="导航" data-context="h950" data-ismove="1" data-isdel="0" data-isedit="1" data-isadd="1" data-width="650" data-uri="/module/moduleForm.htm?widgetId=12346745824&amp;sid=340826219&amp;pageId=1147251295">
                                            	<span>导航</span>
                                            </div>
                                    	</div>	
                                        
                                    </div>
                                    
                                </div>
                            </div>
                            
                            <div class="layout-bd">
                            	<div class="layout-block srml layout" data-ltype="srml" data-widgetid="13072503471" data-componentid="1" data-context="bd" data-prototypeid="1" data-id="13072503471">
                                	<div class="layoutop">
                                    	<a href="javascript:void(0)" class="move" title="移动">移动</a>
                                        <a href="javascript:void(0)" class="edit" title="编辑">编辑</a>
                                        <a href="javascript:void(0)" class="del" title="删除">删除</a>
                                    </div>
                                    <div class="col-main">
                                    	<div class="main-wrap J_TRegion" data-modules="main" data-width="b750">
                                        	<div class="J_TModule tb-module shop13162830681" data-widgetid="13162830681" data-componentid="8806" data-spm="'110.0.8806-13162830681'" microscope-data="'8806-13162830681'" data-title="图片轮播" data-context="b950-b190-b750-b550" data-ismove="1" data-isdel="1" data-isedit="1" data-isadd="1" data-width="773" data-uri="/module/moduleForm.htm?widgetId=13162830681&amp;sid=340826219&amp;pageId=1147251295"><span>图片轮播</span><a href="#del" class="act-del"></a></div>
                                            <div class="J_TModule tb-module shop13162736734" data-widgetid="13162736734" data-componentid="8805" data-spm="'110.0.8805-13162736734'" microscope-data="'8805-13162736734'" data-title="自定义内容区" data-context="b950-f950-b190-b750-b550" data-ismove="1" data-isdel="1" data-isedit="1" data-isadd="1" data-width="880" data-uri="/module/moduleForm.htm?widgetId=13162736734&amp;sid=340826219&amp;pageId=1147251295"><span>自定义内容区</span><a href="#del" class="act-del"></a></div>
                                        </div>
                                    </div>
                                    <div class="col-sub J_TRegion" data-modules="sub" data-width="b190">
        
                                        <div class="J_TModule tb-module shop13072654075" data-widgetid="13072654075" data-componentid="8802" data-spm="'110.0.8802-13072654075'" microscope-data="'8802-13072654075'" data-title="宝贝排行榜" data-context="b190" data-ismove="1" data-isdel="1" data-isedit="1" data-isadd="1" data-width="" data-uri="/module/moduleForm.htm?widgetId=13072654075&amp;sid=340826219&amp;pageId=1147251295"><span>宝贝排行榜</span><a href="#del" class="act-del"></a></div>
                                        
                                    
                                        <div class="J_TModule tb-module shop13072576741" data-widgetid="13072576741" data-componentid="4010" data-spm="'110.0.4010-13072576741'" microscope-data="'4010-13072576741'" data-title="宝贝分类（竖向）" data-context="b190" data-ismove="1" data-isdel="1" data-isedit="1" data-isadd="1" data-width="720" data-istarget="1" data-uri="//siteadmin.taobao.com/category/index.htm?sid=340826219"><span>宝贝分类（竖向）</span><a href="#del" class="act-del"></a></div>
                                        <div class="J_TModule tb-module shop13072654076" data-widgetid="13072654076" data-componentid="8802" data-spm="'110.0.8802-13072654076'" microscope-data="'8802-13072654076'" data-title="宝贝排行榜" data-context="b190" data-ismove="1" data-isdel="1" data-isedit="1" data-isadd="1" data-width="" data-uri="/module/moduleForm.htm?widgetId=13072654076&amp;sid=340826219&amp;pageId=1147251295"><span>宝贝排行榜</span><a href="#del" class="act-del"></a></div>
                                    
                                        <div class="J_TModule tb-module shop13072576742" data-widgetid="13072576742" data-componentid="4010" data-spm="'110.0.4010-13072576742'" microscope-data="'4010-13072576742'" data-title="宝贝分类（竖向）" data-context="b190" data-ismove="1" data-isdel="1" data-isedit="1" data-isadd="1" data-width="720" data-istarget="1" data-uri="//siteadmin.taobao.com/category/index.htm?sid=340826219"><span>宝贝分类（竖向）</span><a href="#del" class="act-del"></a></div>
    
									</div>
                                </div>
                                
                                <div class="layout-block slmr layout" data-ltype="slmr" data-widgetid="13072503472" data-componentid="1" data-context="bd" data-prototypeid="1" data-id="13072503471">
                                	<div class="layoutop">
                                    	<a href="javascript:void(0)" class="move" title="移动">移动</a>
                                        <a href="javascript:void(0)" class="edit" title="编辑">编辑</a>
                                        <a href="javascript:void(0)" class="del" title="删除">删除</a>
                                    </div>
                                    <div class="col-main">
                                    	<div class="main-wrap J_TRegion" data-modules="main" data-width="b750">
                                        	<div class="J_TModule tb-module shop13162830680" data-widgetid="13162830680" data-componentid="8806" data-spm="'110.0.8806-13162830680'" microscope-data="'8806-13162830680'" data-title="图片轮播" data-context="b950-b190-b750-b550" data-ismove="1" data-isdel="1" data-isedit="1" data-isadd="1" data-width="773" data-uri="/module/moduleForm.htm?widgetId=13162830680&amp;sid=340826219&amp;pageId=1147251295"><span>图片轮播</span><a href="#del" class="act-del"></a></div>
                                            <div class="J_TModule tb-module shop13162736738" data-widgetid="13162736738" data-componentid="8805" data-spm="'110.0.8805-13162736738'" microscope-data="'8805-13162736738'" data-title="自定义内容区" data-context="b950-f950-b190-b750-b550" data-ismove="1" data-isdel="1" data-isedit="1" data-isadd="1" data-width="880" data-uri="/module/moduleForm.htm?widgetId=13162736738&amp;sid=340826219&amp;pageId=1147251295"><span>自定义内容区</span><a href="#del" class="act-del"></a></div>
                                        </div>
                                    </div>
                                    <div class="col-sub J_TRegion" data-modules="sub" data-width="b190">
        
                                        <div class="J_TModule tb-module shop13072654075" data-widgetid="13072654075" data-componentid="8802" data-spm="'110.0.8802-13072654075'" microscope-data="'8802-13072654075'" data-title="宝贝排行榜" data-context="b190" data-ismove="1" data-isdel="1" data-isedit="1" data-isadd="1" data-width="" data-uri="/module/moduleForm.htm?widgetId=13072654075&amp;sid=340826219&amp;pageId=1147251295"><span>宝贝排行榜</span><a href="#del" class="act-del"></a></div>
                                    
                                        <div class="J_TModule tb-module shop13072576741" data-widgetid="13072576741" data-componentid="4010" data-spm="'110.0.4010-13072576741'" microscope-data="'4010-13072576741'" data-title="宝贝分类（竖向）" data-context="b190" data-ismove="1" data-isdel="1" data-isedit="1" data-isadd="1" data-width="720" data-istarget="1" data-uri="//siteadmin.taobao.com/category/index.htm?sid=340826219"><span>宝贝分类（竖向）</span><a href="#del" class="act-del"></a></div>
                                        <div class="J_TModule tb-module shop13072654076" data-widgetid="13072654076" data-componentid="8802" data-spm="'110.0.8802-13072654076'" microscope-data="'8802-13072654076'" data-title="宝贝排行榜" data-context="b190" data-ismove="1" data-isdel="1" data-isedit="1" data-isadd="1" data-width="" data-uri="/module/moduleForm.htm?widgetId=13072654076&amp;sid=340826219&amp;pageId=1147251295"><span>宝贝排行榜</span><a href="#del" class="act-del"></a></div>
                                    
                                        <div class="J_TModule tb-module shop13072576742" data-widgetid="13072576742" data-componentid="4010" data-spm="'110.0.4010-13072576742'" microscope-data="'4010-13072576742'" data-title="宝贝分类（竖向）" data-context="b190" data-ismove="1" data-isdel="1" data-isedit="1" data-isadd="1" data-width="720" data-istarget="1" data-uri="//siteadmin.taobao.com/category/index.htm?sid=340826219"><span>宝贝分类（竖向）</span><a href="#del" class="act-del"></a></div>
    
									</div>
                                </div>
                                
                                <div class="layout-block mall layout" data-ltype="mall" data-widgetid="13075303429" data-componentid="8805" data-context="bd" data-prototypeid="8805" data-id="13075303429">
                                	<div class="layoutop">
                                    	<a href="javascript:void(0)" class="move" title="移动">移动</a>
                                        <a href="javascript:void(0)" class="edit" title="编辑">编辑</a>
                                        <a href="javascript:void(0)" class="del" title="删除">删除</a>
                                    </div>
                                    <div class="main-wrap J_TRegion" data-modules="main" data-width="b950" >
                                    	<div class="tb-module J_TModule" data-context="b950-b190-b750-b550" data-componentid="8806" data-widgetid="13172909511" data-ismove="1" data-isdel="1" style="visibility: visible;"><span>图片轮播</span><a href="#del" class="act-del"></a></div></div>
                                </div>
                                	
                                
                                <div class="layout-block mall layout" data-ltype="mall" data-widgetid="13170061768" data-componentid="8805" data-context="bd" data-prototypeid="8805" data-id="13170061768">
                                	<div class="layoutop">
                                    	<a href="javascript:void(0)" class="move" title="移动">移动</a>
                                        <a href="javascript:void(0)" class="edit" title="编辑">编辑</a>
                                        <a href="javascript:void(0)" class="del" title="删除">删除</a>
                                    </div>
                                    <div class="col-main">
                                            <div class="main-wrap J_TRegion" data-modules="main" data-width="b950">
                                                
                                        		<div class="J_TEmptyBox emptyp J_TModule" data-ismove="0"><span>请拖入模块</span></div>
                                        	</div>
                                    </div>
                                 </div>
                                
                            </div>
                            
                            <div class="layout-new">
                            	<a class="J_AddLayout add-layout" href="#">添加布局单元</a>
                            </div>
                            <div class="layout-ft">    
                                <div class="layout grid-m layout-block" data-ltype="lft" data-widgetid="12346745825" data-componentid="33" data-prototypeid="33" data-id="12346745825" data-max="1">
                                	<div class="title">店铺页尾</div>
                                    <div class="col-main">
                                        <div class="main-wrap J_TRegion" data-modules="main" data-width="f950" data-max="1">
                                            
                                    		<div class="J_TEmptyBox emptyp J_TModule" data-ismove="0"><span>请拖入模块</span></div>
                                        </div>
                                	</div>
                            	</div>                            
                            </div>
                            
                            <div class="system-ft">
                            	<p>2015 &copy; 装途网 版权所有</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="pops">
	<div class="popwrap pop_layouttype popedit" >
    	<a href="javascript:void(0)" class="closepop"><span></span></a>
        <div class="popcon">
			<div class="pophead">布局管理</div>
			<div class="popbody">
				<div class="add-layout-list">
					<span class="extra">单位：像素</span>

					<div data-modules="main" data-type="mall">
						<a data-componentid="231" class="mall" href="#" data-width="b950"></a>
					</div>

					<div data-modules="main,sub" data-type="slmr,srml">
						<a data-componentid="1" class="slmr" href="#" data-width="b750"></a>
						<a data-componentid="228" class="srml" href="#" data-width="b750"></a>
					</div>

					<div data-modules="main,sub,extra" data-type="grid-s5m0e5,grid-m0s5e5,grid-s5e5m0">
						<a data-componentid="20" class="l-grid-s5m0e5" href="#" data-width="b550"></a>
						<a data-componentid="229" class="l-grid-m0s5e5" href="#" data-width="b550"></a>
						<a data-componentid="230" class="l-grid-s5e5m0" href="#" data-width="b550"></a>
					</div>

				</div>
			</div>

        </div>
    </div>
</div>



<script type="text/javascript" language="javascript">

document.body.onselectstart = function(){
	return false;
}

var params={
	dragflag:false,
	dragtype:0,
	dragmod:{modid:0,wtype:"",source:false,sourceid:0},
	createxu:false,
	modpos:{"left":0,"top":0},
	startX:0,
	startY:0,
	curX:0,
	curY:0,
	zmod:{index:-1,half:0},
	arregions:[],
	arblocks:[]
}

function clearmodpos(){
	params.dragflag=false;
	params.dragtype=0;
	params.dragmod={modid:0,wtype:"",source:false,sourceid:0};
	params.createxu=false;
	params.modpos={"left":0,"top":0};		
	params.startX=0;
	params.startY=0;
	params.zmod={"index":-1,"half":true}
}


var arzmodspos=[];

function initpos(){
	params.arregions=[];
	params.arblocks=[];
	arzmodspos=[];
	var objblocks=$(".layout-block");
	objblocks.each(function(i, e) {
		$e=$(e);
        var pblock= GetPosition(e);
		pblock.h= e.offsetHeight;
		pblock.w= e.offsetWidth;
		pblock.id= $e.attr("data-id");
		pblock.wgetid= $.attr("data-widgetid");
		pblock.blocktype= $e.attr("data-ltype");
		params.arblocks.push(pblock);
		$e.attr("data-blockindex",i);
    });
	
	var objregions=$(".J_TRegion");
	objregions.each(function(i, e) {
		var $e= $(e);
		var pregion= GetPosition(e);
		pregion.blocki= $e.closest(".layout-block").attr("data-blockindex");
		pregion.h= e.offsetHeight;
		pregion.w= e.offsetWidth;
		pregion.rtype= $e.attr("data-modules");
		pregion.wtype= $e.attr("data-width");
		pregion.arzmods= [];
        var objzmods= $e.find(".J_TModule");
		objzmods.each(function(ii, ee) {
			var $ee=$(ee);
            var pzmod= GetPosition(ee);
			pzmod.h= ee.offsetHeight;
			pzmod.w= ee.offsetWidth;
			pzmod.modid= $ee.attr("data-componentid");
			pzmod.wgetid= $ee.attr("data-widgetid");
			pzmod.towtype= $ee.attr("data-context");
			pregion.arzmods.push(pzmod);
        });
		params.arregions.push(pregion);
			
    });
	
	var objzmods= $(".J_TModule");
	//alert($(".pagein").width());
	objzmods.each(function(i, e) {
        var $e=$(e);
		var $b=$e.closest(".layout-block");
		var maxnum= $b.attr("data-max")?$b.attr("data-max"):0;
		var pos=GetPosition(e);
		var pzmod={"x":pos.left,"y":pos.top};
		pzmod.h= e.offsetHeight;
		pzmod.w= e.offsetWidth; 
		pzmod.modinregion= $e.index();
		pzmod.isempty= $e.hasClass("emptyp");
		pzmod.maxnum= maxnum;
		pzmod.accwtype=$e.parent().attr("data-width");
		pzmod.modid= $e.attr("data-componentid");
		pzmod.wgetid= $e.attr("data-widgetid");
		pzmod.towtype= $e.attr("data-context");
		arzmodspos.push(pzmod);
    });
}


function setarzmodspos(p){
	arzmodspos=p;
	console.log(arzmodspos);
}


function GetPosition(obj)
{
	var left = 0;
	var top   = 0;

	while(obj != document.body )
	{
		left +=	obj.offsetLeft;
		top  += obj.offsetTop;
		if(!obj.offsetParent )
		{obj=document.body}
		else
		{obj = obj.offsetParent;}	
	}
	return {"left":left,"top":top};
}

function iFrameHeightcw(){
	var ifm=document.getElementById("iframepage");
	var refer=document.querySelector(".conrefer");
	var subWeb = document.frames? document.frames["iframepage"].document : ifm.contentDocument;
	if(ifm != null && subWeb !=null){
		ifm.width = document.body.scrollWidth-80;
		subWeb.body.style.width = ifm.width+"px";
		ifm.height = subWeb.body.scrollHeight;
		refer.style.height=subWeb.body.scrollHeight+"px";
	    refer.style.width = document.body.scrollWidth-80+"px";
		ifm.contentWindow.abc();
		subWeb.body.style.width = ifm.width+"px";
		
	}
}

   
function iFrameHeight() {   
var ifm= document.getElementById("iframepage");   
var refer=document.querySelector(".conrefer");
var subWeb = document.frames ? document.frames["iframepage"].document : ifm.contentDocument;   
	if(ifm != null && subWeb != null) {
	   ifm.height = subWeb.body.scrollHeight;
	   ifm.width = document.body.scrollWidth-80;
	   refer.style.height=subWeb.body.scrollHeight+"px";
	   refer.style.width = document.body.scrollWidth-80+"px";
	}   
}   



$(function(){
	
	initpos();
	$(".toolbar").addClass("laytoolbar");
	
	$(".modsbox .emwrap em").on("mousedown",function(event){
		params.dragflag=true;	
		params.dragtype=1;
		if(!event){
			event = window.event;
			//防止IE文字选中
			this.onselectstart = function(){
				return false;
			}  
		}
		
		var e = event;
		params.startX = e.clientX;
		params.startY = e.clientY;
		params.dragmod={"modid":$(this).attr("data-modid"),"wtype":$(this).attr("data-wtype"),"title":$(this).attr("title"),"source":false,"sourceid":0};
		params.modpos = GetPosition(this);
		
	})
	
	$(".layouteditmain").on("mousedown",".tb-module",function(event){
		if(parseInt($(this).attr("data-ismove"))===0){return;}
		params.dragflag=true;
		params.dragtype=2;
		if(!event){
			event=window.event;
			this.onselectstart=function(){
				return false;	
			}	
		}	
		var e=event;
		params.startX = e.clientX;
		params.startY = e.clientY;
		params.dragmod= {"modid":$(this).attr("data-componentid"),"totindex":$(".J_TModule").index(this),"mod-wgtid":$(this).attr("data-widgetid"),"wtype":$(this).attr("data-context"),"lmodwidth":this.offsetWidth,"lmodindex":$(this).index(),"lmodhtml":this.outerHTML,"title":$(this).attr("data-title"),"rtype":$(this).parent().attr("data-modules"),"blockid":$(this).closest(".layout-block").attr("data-id")};
		params.modpos = GetPosition(this);
		console.log(params.dragmod);
	})

	$(".layout-new a").click(function(){
		$(".pops").show().find(".pop_layouttype").removeClass("layedit").show();

	});

	$(".layout-con").on("click",".edit",function(){
		var $objlayblock= $(this).closest(".layout-block");
		var blockid= $objlayblock.attr("data-widgetid");
		var ltype= $objlayblock.attr("data-ltype");
		$(".pops").show().find(".pop_layouttype").addClass("layedit").show().attr("data-widgetid",blockid).find("."+ltype).addClass("on");
	})



	$(".pops .popwrap .closepop").click(function(){
		$(".pops").find(".popwrap:visible").find(".on").removeClass("on").end().hide().end().hide();
	})
	
	$("body").on("mousemove",function(event){
		if(params.dragflag){
			if(params.dragtype===1){
				var modid= params.dragmod.modid;
				var jsonpos= params.modpos;
				if(!params.createxu){
					$("<div class='dragxu modxu'>"+params.dragmod.title+"</div>").css(jsonpos).appendTo("body");
					params.createxu=true;
				}
				else{
					event = event || window.event;
					$(".dragxu").css({left:params.modpos.left+event.clientX-params.startX,top:params.modpos.top+event.clientY-params.startY});
					$(".dragxu")[0].onselectstart=function(ev){ return false;}
				}			
				var aaa = getzmodindex({"x":event.pageX+$(".pagein").scrollLeft(),"y":event.pageY+$(".pagein").scrollTop()});		
			}
			else if(params.dragtype===2){
				var dragmod=params.dragmod;
				var modid= dragmod.modid;
				var jsonpos= params.modpos;
				if(!params.createxu){
					$("<div class='dragxu lmodxu' style='width:"+(dragmod.lmodwidth-4)+"px'></div>").css(jsonpos).appendTo("body");
					$(".J_TModule").eq(dragmod.totindex).hide().after("<div class='zmodposxu'></div>");
					params.createxu=true;
					initpos();
				}
				else{
					event = event || window.event;
					$(".dragxu").css({left:params.modpos.left+event.clientX-params.startX-$(".pagein").scrollLeft(),top:params.modpos.top+event.clientY-params.startY-$(".pagein").scrollTop()});
					$(".dragxu")[0].onselectstart=function(ev){ return false;}
				}
				var aaa = getzmodindex({"x":event.pageX+$(".pagein").scrollLeft(),"y":event.pageY+$(".pagein").scrollTop()});	
			}
			
								
		}
					
	})
	
	$(".layouteditmain").on("click",".act-del",function(){
		var objzmod= $(this).parent();
		if(objzmod.siblings(".J_TModule").length){
			objzmod.remove();
		}
		else{
			objzmod.replaceWith("<div class='J_TEmptyBox emptyp J_TModule' data-ismove='0'><span>请拖入模块</span></div>");
		}
	})
	
	$(".layouteditmain").on("click",".layout-block .layoutop .del",function(){
		if(confirm('删除布局会将布局内的模块一并删除，确定要删除吗?')){
			var $layoutblock =$(this).parent().parent();
			$layoutblock.animate({height:"0"},function(){
				$(this).remove();	
				initpos();
			})
		}	
	})
	
	$("body").on("mouseup",function(event){
		e = event || window.event;
		
		if(params.dragflag){
			var dragtype=params.dragtype;
			var dragmod= params.dragmod;
			var zmod = params.zmod;
			var objzmods= $(".J_TModule");
			
			if( (e.clientX!==params.startX) || (e.clientY !== params.startY)){
				if(dragtype===1){
					
					if(zmod.index!==-1){
						$(".zmodposxu").siblings(".emptyp").remove().end().replaceWith("<div class=\"J_TModule tb-module shop13162830699\" data-widgetid=\"13162830699\" data-componentid=\""+dragmod.modid+"\" data-spm=\"'110.0.8806-13162830699'\" microscope-data=\"'8806-13162830699'\" data-title=\""+dragmod.title+"\" data-context=\""+dragmod.wtype+"\" data-ismove=\"1\" data-isdel=\"1\" data-isedit=\"1\" data-isadd=\"1\" data-width=\"773\" data-uri=\"/module/moduleForm.htm?widgetId=13162830699&amp;sid=340826219&amp;pageId=1147251295\"><span>"+dragmod.title+"</span><a href=\"#del\" class=\"act-del\"></a></div>");
					}
				}
				else if(dragtype===2){
					if(zmod.index=== -1){
						objzmods.eq(dragmod.totindex).show().siblings(".zmodposxu").remove();
					}
					else{
						
						if(zmod.index=== dragmod.totindex){
							objzmods.eq(zmod.index).siblings("div").addClass("J_TModule").show().end().remove();
							$(".zmodposxu").remove();
						}
						else{
							if(!arzmodspos[dragmod.totindex].isempty){
								objzmods.eq(dragmod.totindex).remove();
							}
							if(arzmodspos[zmod.index].isempty){
								objzmods.eq(zmod.index).remove();
							}
							
												
							$(".zmodposxu").replaceWith(dragmod.lmodhtml);		
						}
	
					}
					
				}
				
				//if(chkcandrop() ){
					//document.getElementById("iframepage").contentWindow.zmodadd();
					//zmodadd();
					
				//}		
				$(".dragxu").remove();
			}
			
			
			clearmodpos();
			initpos();
		}
	})
	
	
	$("#conrefer").on("mousemove",function(event){
		var x=event.pageX,y=event.pageY;
		
		if(!params.dragflag){
			getzmodindex(getrelpos({"x":event.pageX,"y":event.pageY}));
			event.stopPropagation();
		}
		
	})
	
	$(".modtoolbox .del").click(function(){
		var zmod= params.zmod;
		var zmodparas= arzmodspos[zmod.index];
		var zmodid= zmodparas["id"];
		$.ajax({
			type:"GET",
			url: "/modop.json?op=del&id="+zmodid+"",
			dataType:"json",
			timeout:5000,
			success: function(data,status){	
				if(data.status==1){
					$(".modtoolbox").animate({"height":"0px","width":"0px"},500,function(){$(this).hide()});
					document.getElementById("iframepage").contentWindow.zmodremove(zmodid);
					params.zmod= {index:-1,half:0};
					console.log("删除成功!");
				}
				else{
					console.log("删除失败"+data.msg);
				}	
			}
			,error:function(XHR, textStatus, errorThrown){
				console.log(textStatus+"\n"+errorThrown);
				self.isloading=0;
			}
		});
		return false;
	})
	
	
	
})

function zmodadd(){
	var dragmod= params["dragmod"];
	var zmod= params["zmod"];
	var zmodpara= arzmodspos[zmod.index];
	var accwtype=zmodpara["accwtype"];
		
	$.ajax({
		type:"GET",
		url: "modhtml/"+dragmod["modid"]+accwtype+".html?op=add&modid="+dragmod["modid"]+"&accwtype="+accwtype,
		dataType:"html",
		timeout:5000,
		success: function(data,status){
			document.getElementById("iframepage").contentWindow.zmodadd(data,params.zmod);
			console.log("添加成功!");
		}
		,error:function(XHR, textStatus, errorThrown){
			console.log(textStatus+"\n"+errorThrown);
			self.isloading=0;
		}
	});
}


function getrelpos(pos){
	var dompagein = document.querySelector(".pagein");
	var pageinpos=GetPosition(dompagein);	
	var realx= pos.x + dompagein.scrollLeft - pageinpos.left;
	var realy= pos.y + dompagein.scrollTop -pageinpos.top;
	//console.log("realx:"+realx +";realy:"+realy);	
	console.log("pos.x"+pos.x+"scroll"+dompagein.scrollLeft+"pageinposleft"+pageinpos.left+"---posy"+pos.y+"pageintop"+dompagein.scrollTop+"pageinpos"+pageinpos.top);
	
	return {"x":realx,"y":realy}
}

function getzmodindex(pos){
	
	//console.log(pos);	
	//console.log(params.zmod);
	var finded=false;
	var objres= {index:-1,half:0};
	var zmod= params.zmod;
	var objzmods=$(".J_TModule");
	//var arregions=params.arregions;
	$.each(arzmodspos,function(i,v){
		if(!finded){
			if(pos.x>v.x && pos.x< v.x+v.w && pos.y>v.y && pos.y<v.y+v.h){
				var dragmod=params.dragmod;
				//console.log("找到了"+i);
				var objzmod= objzmods.eq(i);
				if(dragmod.wtype.indexOf(v.accwtype)===-1){
					finded=true;
					objres={index: zmod.index,half: zmod.half};
					return false;
				}
				
				
				
				var nowhalf =pos.y<(v.y+v.h/2);
				if(nowhalf !== zmod.half || i!== zmod.index ){
					//console.log("i:"+i+"half:"+nowhalf);
					
					if(params.dragtype===2 || 1===1){
						
						if(i!==zmod.index && zmod.index!==-1 && arzmodspos[zmod.index].isempty){
							objzmods.eq(zmod.index).show();
						}
						
						
						if(zmod.index===-1 && objzmods.eq(params.dragmod.totindex).siblings(".J_TModule").length===0){
							$(".zmodposxu").siblings(".J_TModule").removeClass("J_TModule").after("<div class='J_TEmptyBox emptyp J_TModule' data-ismove='0'><span>请拖入模块</span></div>");						
						}
					}					
					
					
					$(".zmodposxu").remove();
					
					if(v.isempty){
						objzmod.before("<div class='zmodposxu'></div>").hide();
					}
					else{
						if(nowhalf){
							objzmod.before("<div class='zmodposxu'></div>");	
						}
						else{
							objzmod.after("<div class='zmodposxu'></div>");	
						}
					}
					initpos();
				}
					
				finded = true;			
				objres= {index:i, half:nowhalf}	
			}	
		}	
	});
	
	
	
	if(finded){
		params.zmod = objres;
		return objres;
	}
	else{
		//params.zmod = {index:-1,half:0};
		//return {index:-1,half:0};
	}
	
}

function chkcandrop(){
	var dragmod= params.dragmod;
	var zmod = params.zmod;
	if(zmod.index===-1){console.log("zmodindex-1"); return false; }
	var zmodparas = arzmodspos[zmod.index];
	if(zmodparas.accwtype===null){console.log("accwtype-null"); return false};	
	if(dragmod.wtype.indexOf(zmodparas.accwtype)===-1){
		console.log("not this width");
		return false;	
	}
	return true;
}






</script>
</body>
</html>
